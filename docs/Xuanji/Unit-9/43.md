# 第九章 - blueteam 的小心思 2

## 1

> nacos 的 key 为多少 flag\{base64decodekey\}

这个环境并不是常规的上机进行应急的题目，这里需要先对靶机进行渗透攻击

### 扫描靶机的开放端口

:::info

需要注意，环境启动需要一定时间，请稍等3分钟左右再开始扫描操作

同时，建议使用云服务器进行扫描，校园网和流量热点都有出现不同情况的干扰

:::

```plaintext title="nmap"
Nmap scan report for ec2-52-82-27-37.cn-northwest-1.compute.amazonaws.com.cn (52.82.27.37)
Host is up, received echo-reply ttl 43 (0.053s latency).
Scanned at 2024-05-26 16:18:35 CST for 65s
Not shown: 65520 closed ports
Reason: 65520 resets
PORT     STATE    SERVICE          REASON         VERSION
80/tcp   filtered http             no-response
135/tcp  filtered msrpc            no-response
136/tcp  filtered profile          no-response
137/tcp  filtered netbios-ns       no-response
138/tcp  filtered netbios-dgm      no-response
139/tcp  filtered netbios-ssn      no-response
443/tcp  filtered https            no-response
445/tcp  filtered microsoft-ds     no-response
593/tcp  filtered http-rpc-epmap   no-response
2222/tcp open     ssh              syn-ack ttl 42 OpenSSH 7.9p1 Debian 10+deb10u3 (protocol 2.0)
| ssh-hostkey: 
|   2048 39:26:71:4c:4f:48:c1:4c:75:f5:2b:6e:1e:5f:a1:0d (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDScdsKvBjbOe7CjYm9G72Ew8uoxRv5tW1GnMJ9xBhddn61r7Q9EAhKl9a09tqfkc9PMHLrbg4sUFplCadSBATDcvTsazozoYto7NVuNoJD12R5O5VgoVDzzk29bID0gWoYcsGKuZjJ9BOJ/CDMHExkHq38wfisrUbAaPS27UM3e1DOKuGMDzi18BKsj1ZCOuqDio9jUjhh3xKxuWqPLkc12DLq4oSVOGMZOX85xj261BWoqgOwVTBmDt0FC+z0fiJlZYLs3xboqxWpIjUN70kDwJjOz1Oen/UX5mldViig4fcj337OQsOZhAfMez7BqtEOY7BcCI+lU9r5eg4zNuNv
|   256 9b:38:86:a7:6c:e2:5b:43:0b:19:ae:05:71:54:7a:16 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOmA2ukt6Jc8jLKDMZBNDcZnQBRsO+wQaiOUuyeQELgZNjpz4WuDSjw3mI6yNpwzySl5jt7sZ1A5muuSCNb6K0I=
|   256 3b:42:08:0a:93:83:c1:97:08:50:d8:28:59:e4:27:23 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIARiXHVhbRW2QY2h2UMG6ZJBsz8DmScnvoRpeqH79epF
4444/tcp filtered krb524           no-response
5000/tcp open     http             syn-ack ttl 41 Docker Registry (API: 2.0)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Site doesn't have a title.
8080/tcp filtered http-proxy       no-response
8082/tcp open     blackice-alerts? syn-ack ttl 41
| fingerprint-strings: 
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, Help, Kerberos, RPCCheck, RTSPRequest, SSLSessionReq, TLSSessionReq, TerminalServerCookie: 
|     HTTP/1.1 400 
|     Date: Sun, 26 May 2024 08:19:00 GMT
|     Connection: close
|   FourOhFourRequest: 
|     HTTP/1.1 404 
|     Content-Type: application/json;charset=UTF-8
|     Date: Sun, 26 May 2024 08:18:55 GMT
|     Connection: close
|     {"timestamp":"2024/05/26 16:18:55","status":404,"error":"Not Found","message":"No message available","path":"/nice%20ports%2C/Tri%6Eity.txt%2ebak"}
|   GetRequest: 
|     HTTP/1.1 302 
|     Set-Cookie: JSESSIONID=B7F3E564B8918E2D2C135099568E6B6F; Path=/; HttpOnly
|     Location: http://localhost:8082/login.html
|     Content-Length: 0
|     Date: Sun, 26 May 2024 08:18:55 GMT
|     Connection: close
|   HTTPOptions: 
|     HTTP/1.1 200 
|     Allow: GET,HEAD,POST,PUT,PATCH,DELETE,OPTIONS
|     Content-Length: 0
|     Date: Sun, 26 May 2024 08:19:00 GMT
|_    Connection: close
8848/tcp open     unknown          syn-ack ttl 40
| fingerprint-strings: 
|   GetRequest, HTTPOptions: 
|     HTTP/1.1 404 
|     Content-Type: text/html;charset=utf-8
|     Content-Language: en
|     Content-Length: 431
|     Date: Sun, 26 May 2024 08:19:00 GMT
|     Connection: close
|     <!doctype html><html lang="en"><head><title>HTTP Status 404 
|     Found</title><style type="text/css">body {font-family:Tahoma,Arial,sans-serif;} h1, h2, h3, b {color:white;background-color:#525D76;} h1 {font-size:22px;} h2 {font-size:16px;} h3 {font-size:14px;} p {font-size:12px;} a {color:black;} .line {height:1px;background-color:#525D76;border:none;}</style></head><body><h1>HTTP Status 404 
|     Found</h1></body></html>
|   RTSPRequest: 
|     HTTP/1.1 400 
|     Content-Type: text/html;charset=utf-8
|     Content-Language: en
|     Content-Length: 435
|     Date: Sun, 26 May 2024 08:19:00 GMT
|     Connection: close
|     <!doctype html><html lang="en"><head><title>HTTP Status 400 
|     Request</title><style type="text/css">body {font-family:Tahoma,Arial,sans-serif;} h1, h2, h3, b {color:white;background-color:#525D76;} h1 {font-size:22px;} h2 {font-size:16px;} h3 {font-size:14px;} p {font-size:12px;} a {color:black;} .line {height:1px;background-color:#525D76;border:none;}</style></head><body><h1>HTTP Status 400 
|_    Request</h1></body></html>
```

### 获取nacos镜像数据

在其中发现有Docker Registry服务，尝试进行访问

```json title="http://52.82.27.37:5000/v2/_catalog"
{
    "repositories": [
        "nacos"
    ]
}
```

发现存在有`nacos`镜像，查看镜像的tags

```json title="http://52.82.27.37:5000/v2/nacos/tags/list"
{
    "name": "nacos",
    "tags": [
        "latest"
    ]
}
```

尝试将镜像获取到本地，首先需要改写本地docekr的安全策略，允许http不安全的注册表

```json title="/etc/docker/daemon.json"
{
    "insecure-registries" : [ "52.82.27.37:5000" ]
}
```

然后重启dockerd

```shell
sudo systemctl daemon-reload
sudo systemctl restart docker
```

下载镜像

```shell
randark@developer:~/temp$ docker pull 52.82.27.37:5000/nacos:latest
latest: Pulling from nacos
2d473b07cdd5: Pull complete 
8e2e6bf0e569: Pull complete 
c7276c1c2105: Pull complete 
2694550f92f1: Pull complete 
b043b5656d6f: Pull complete 
103731dfc453: Pull complete 
e1dec0556439: Pull complete 
4f4fb700ef54: Pull complete 
48ba5d7d5cad: Pull complete 
Digest: sha256:42ea3485ea154fbbc6b6bd26f497f046b1355e888fc1792d87a143644945dfb8
Status: Downloaded newer image for 52.82.27.37:5000/nacos:latest
52.82.27.37:5000/nacos:latest
```

然后基于此镜像启动一个容器

```shell
randark@developer:~/temp$ docker run -d 52.82.27.37:5000/nacos
85bc4f99c050386699c96560d65fd8150d88b4989d75158d8d23cc0b9e0955d9
```

将vscode附加进此容器，开始审计

![img](img/image_20240547-164746.png)

在`/home/nacos`目录下启动vscode进行审计，以key作为关键词进行搜索，可以找到这条记录

```plaintext title="/home/nacos/conf/application.properties"
nacos.core.auth.plugin.nacos.token.secret.key=eGpuYWNvczIwMjNwZW5ndWluZWRpc2VjZmxhZ2ZsYWdmbGFn
```

经过Base64解码后得到

```plaintext
eGpuYWNvczIwMjNwZW5ndWluZWRpc2VjZmxhZ2ZsYWdmbGFn
xjnacos2023penguinedisecflagflagflag
```

```flag
flag{xjnacos2023penguinedisecflagflagflag}
```

## 2

> nacos配置文件的 flag

TODO 打不进去了，碰壁ing

```flag

```

## 3

```flag

```

## 4

```flag

```
